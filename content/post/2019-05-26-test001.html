---
title: "Beta-binomial responder rate"
subtitle: "Decision based on posterior probability of ORR>15%"
author: mgrafit
date: '2019-05-26'
slug: test001
categories:
  - R, Bayes
tags:
  - Bayesian, ORR
---



<p><span class="math display">\[ \]</span>
<span class="math display">\[ \]</span>
<span class="math display">\[ \]</span>
<span class="math display">\[ \]</span></p>
<div id="exact-95ci" class="section level2">
<h2>Exact 95%CI</h2>
<p>Assuming an early clinical trial, with 1 responder out of 24 patients. The 95% confidence interval for the responder rate can be calculated exactly, and is known as the Clopper-Pearson exact method.</p>
<pre class="r"><code>exaci&lt;-PropCIs::exactci(x=1, n=24, conf.level=0.95)
round(exaci$conf.int, 4)</code></pre>
<pre><code>## [1] 0.0011 0.2112
## attr(,&quot;conf.level&quot;)
## [1] 0.95</code></pre>
</div>
<div id="using-a-bayesian-approach" class="section level2">
<h2>Using a Bayesian approach</h2>
<p>The beta-binomial distribution (<a href="https://www.wikiwand.com/en/Beta-binomial_distribution" class="uri">https://www.wikiwand.com/en/Beta-binomial_distribution</a>) is the binomial distribution in which the probability of success at each trial is fixed but randomly drawn from a beta distribution prior to n Bernoulli trials.</p>
<p>Assuming the responder/non-responder outcome has been registered in the below order, we want to see how our prior belief is updated as evidence accumulates during a Ph1 oncology clinical trial.</p>
<pre class="r"><code>#&#39; total sample size (n); successes (Y)
n=24;Y=1; 
#&#39; beta prior
a=1; b=4
#&#39; prop. grid   
grid   &lt;- seq(0,1,length.out=100)
#&#39; elements
like &lt;- dbinom(Y,n,grid); like=like/sum(like) #standardize
prior&lt;- dbeta(grid,a,b); prior=prior/sum(prior) #standardize
post &lt;- like*prior; post&lt;-post/sum(post)

df&lt;-data.frame(grid=rep(grid, 3), 
               probas=c(prior, like, post), 
               value=rep(c(&quot;prior&quot;, &quot;like&quot;, &quot;post&quot;), each=100))

ggplot(df, aes(x=grid, y=probas))+
  geom_density(aes(fill=as.factor(value)), alpha=.3, stat=&quot;identity&quot;) +
  ylab(&quot;Density&quot;)+
  scale_x_continuous(&quot;Probability&quot;)+
  scale_fill_viridis_d(&quot;&quot;) +
  theme_minimal()</code></pre>
<p><img src="/post/2019-05-26-test001_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>Calculation of the posterior mean and 95% interval:</p>
<pre class="r"><code>n=24;Y=1; 
#&#39; beta prior
a=1; b=4
round((Y+a)/(n+a+b), 4)</code></pre>
<pre><code>## [1] 0.069</code></pre>
<pre class="r"><code>round(qbeta(c(0.025, 0.975), Y+a, n-Y+b), 4)</code></pre>
<pre><code>## [1] 0.0088 0.1835</code></pre>
<p>Calculation of the posterior probability that p&gt;0.15:</p>
<pre class="r"><code>n=24;Y=1; 
#&#39; beta prior
a=1; b=4
round(1-pbeta(0.15, Y+a, n-Y+b), 4)</code></pre>
<pre><code>## [1] 0.0627</code></pre>
<p>Had we chosen other priors â€¦</p>
<pre class="r"><code>#&#39; total sample size (n); successes (Y)
n=24;Y=1; 
#&#39; beta prior
a1=1; b1=1 #uniform
a2=2; b2=2 #weakly inf centered on 0.5
a3=1; b3=4 #weakly inf centered on 0.2
#&#39; prop. grid   
grid&lt;- seq(0,1,length.out=100)
#&#39; elements
like &lt;- dbinom(Y,n,grid); like=like/sum(like) #standardize
prior1&lt;- dbeta(grid,a1,b1); prior1=prior1/sum(prior1) #standardize
prior2&lt;- dbeta(grid,a2,b2); prior2=prior2/sum(prior2) #standardize
prior3&lt;- dbeta(grid,a3,b3); prior3=prior3/sum(prior3) #standardize
post1 &lt;- like*prior1; post1&lt;-post1/sum(post1)
post2 &lt;- like*prior2; post2&lt;-post2/sum(post2)
post3 &lt;- like*prior3; post3&lt;-post3/sum(post3)

df&lt;-data.frame(grid=rep(rep(grid, 3), 3), 
               probas=c(c(prior1, like, post1), c(prior2, like, post2), c(prior3, like, post3)),
               value=rep(rep(c(&quot;prior&quot;, &quot;like&quot;, &quot;post&quot;), each=100), 3),
               scenario=rep(c(&quot;Uniform&quot;, &quot;Centered&quot;, &quot;Skewed&quot;), each=300))

ggplot(df, aes(x=grid, y=probas))+
  geom_density(aes(fill=as.factor(value)), alpha=.3, stat=&quot;identity&quot;) +
  facet_wrap(~scenario, nrow=1)+
  ylab(&quot;Density&quot;)+
  scale_x_continuous(&quot;Probability&quot;)+
  scale_fill_viridis_d(&quot;&quot;) +
  theme_minimal()</code></pre>
<p><img src="/post/2019-05-26-test001_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>The 95% HDI can be calculated as the highest density interval for posterior samples. Unlike equal-tailed intervals that exclude 2.5% from each tail of the distribution, the HDI is not equal-tailed and therefore always includes the mode(s) of posterior distributions.</p>
<pre class="r"><code>n=24;Y=1; 
#&#39; beta prior
a=1; b=4
#&#39; prop. grid   
grid&lt;- seq(0,1,length.out=100)
zhdi&lt;-hdi(qbeta(grid, Y+a, n-Y+b), 0.95)
round(zhdi, 4)</code></pre>
<pre><code>##  lower  upper 
## 0.0000 0.1663 
## attr(,&quot;credMass&quot;)
## [1] 0.95</code></pre>
</div>
<div id="sequential-updates" class="section level2">
<h2>Sequential updates</h2>
<p>As cohorts are providing staggered (with increasing dose levels), the prior and posterior distributions can actually be updated as time goes.</p>
<pre class="r"><code>d&lt;-data.frame(Cohort=c(1, 2, 3, 4, 5, 6),
          Dose=c(65, 160, 400, 400, 800, 1200),
          ncum=c(1, 2, 3, 6, 19, 24), 
          Ycum=c(0, 0, 0, 0, 1, 1),
          a=1, b=4) %&gt;%
  mutate(shap1=Ycum+a, shap2=ncum-Ycum+b)

set.seed(123)

#Use of pmap from https://github.com/jennybc/row-oriented-workflows/blob/master/ex08_nesting-is-good.md
my_dbeta &lt;- function(...) {
  l &lt;- list(...)
  dbeta(x=grid, shape1=l$shap1, shape2=l$shap2)
}

set.seed(123)
lbeta&lt;-pmap(d, my_dbeta)
lbeta2&lt;-map(lbeta, function(x) x/max(x))
dfbeta&lt;-as.data.frame(t(do.call(rbind, lbeta2))) %&gt;%
gather(VCohort, probas) %&gt;% 
mutate(grid=rep(grid, 6), Cohort=as.character(substr(VCohort, 2, 2)))

ggplot(dfbeta, aes(x=grid, y=probas))+
  geom_line()+
  facet_wrap(~Cohort, ncol=1)+
  scale_x_continuous(&quot;Probability&quot;, limits=c(0, .3))+
  ylab(&quot;&quot;)+
  theme_minimal()</code></pre>
<pre><code>## Warning: Removed 70 rows containing missing values (geom_path).</code></pre>
<p><img src="/post/2019-05-26-test001_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p>Related posts include:
<a href="https://cran.r-project.org/web/packages/rstanarm/vignettes/betareg.html" class="uri">https://cran.r-project.org/web/packages/rstanarm/vignettes/betareg.html</a>
<a href="http://www.sumsar.net/blog/2018/12/visualizing-the-beta-binomial/" class="uri">http://www.sumsar.net/blog/2018/12/visualizing-the-beta-binomial/</a>
<a href="https://www4.stat.ncsu.edu/~reich/ABA/notes/BetaBinom.pdf" class="uri">https://www4.stat.ncsu.edu/~reich/ABA/notes/BetaBinom.pdf</a>
<a href="https://en.wikipedia.org/wiki/Beta-binomial_distribution" class="uri">https://en.wikipedia.org/wiki/Beta-binomial_distribution</a>
<a href="http://www.koenbro.com/the-beta-distribution/#highest-density-interval" class="uri">http://www.koenbro.com/the-beta-distribution/#highest-density-interval</a></p>
<p>And this is a link to the <embed src="/pdfs/Blogtest.pdf" /> document.</p>
</div>
